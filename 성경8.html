<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>성경</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root { --main: #3e2723; --bg: #fdfaf7; --select: #e0f2f1; --hl: #fff176; --accent: #00796b; --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        body { font-family: sans-serif; margin: 0; background: var(--bg); color: #333; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        
        header { background: var(--main); color: white; padding: 10px; position: sticky; top: 0; z-index: 1000; display: flex; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.2); height: 50px; }
        .header-title { flex: 1; text-align: center; display: flex; justify-content: center; gap: 10px; }
        .nav-box { background: rgba(255,255,255,0.15); padding: 5px 12px; border-radius: 20px; font-size: 15px; font-weight: bold; position: relative; display: flex; align-items: center; }
        .nav-box select { position: absolute; width: 100%; height: 100%; opacity: 0; left: 0; top: 0; cursor: pointer; }

        .side-menu { position: fixed; left: -280px; top: 0; width: 280px; height: 100%; background: white; z-index: 2000; transition: var(--transition); box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
        .side-menu.active { left: 0; }
        .menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1999; display: none; }
        .menu-header { background: var(--main); color: white; padding: 50px 20px 20px; font-size: 22px; font-weight: bold; }
        .menu-item { padding: 18px 20px; display: flex; align-items: center; gap: 15px; cursor: pointer; font-size: 16px; border-bottom: 1px solid #f0f0f0; }

        #content-wrapper { transition: var(--transition); }
        .slide-left { opacity: 0; transform: translateX(-30px); }
        .slide-right { opacity: 0; transform: translateX(30px); }
        #view { padding: 20px 20px 150px; max-width: 600px; margin: auto; }
        .verse { margin-bottom: 6px; padding: 12px; border-radius: 8px; display: flex; line-height: 1.8; }
        .verse.selected { background-color: var(--select); }
        .hl-text { background: var(--hl); border-radius: 3px; padding: 2px 0; }
        .v-num { font-weight: bold; color: #8d6e63; margin-right: 12px; min-width: 25px; }
        .v-text { font-size: 1.15em; word-break: keep-all; }

        .fab-container { position: fixed; bottom: 30px; right: 20px; display: flex; flex-direction: column; gap: 15px; z-index: 999; }
        .fab { width: 56px; height: 56px; background: var(--main); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3); border: none; cursor: pointer; }

        #toolbar { position: fixed; bottom: 30px; left: 20px; right: 90px; background: white; display: none; box-shadow: 0 4px 20px rgba(0,0,0,0.2); border-radius: 50px; z-index: 1001; }
        .tool-btns { display: flex; padding: 5px; }
        .tool-btn { flex: 1; border: none; background: none; padding: 12px; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: bold; font-size: 14px; color: #444; }

        #home-view { padding: 120px 20px; text-align: center; }
        .btn-main { background: var(--main); color: white; padding: 15px 40px; border-radius: 30px; border: none; font-size: 16px; margin: 10px; display: inline-block; cursor: pointer; }
        
        /* 관심성구 아이템 스타일 */
        .hl-item { margin-bottom: 20px; border-bottom: 1px dotted #ccc; padding-bottom: 15px; position: relative; cursor: pointer; user-select: none; -webkit-user-select: none; }
        .hl-item:active { background: rgba(0,0,0,0.05); }

        #toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); color: white; padding: 12px 25px; border-radius: 30px; font-size: 13px; z-index: 3000; display: none; pointer-events: none; }
    </style>
</head>
<body>

<div class="menu-overlay" id="overlay" onclick="toggleMenu()"></div>
<div class="side-menu" id="side-menu">
    <div class="menu-header">메뉴</div>
    <div class="menu-item" onclick="goHome()"><span class="material-icons">home</span>홈으로</div>
    <div class="menu-item" onclick="goToRead()"><span class="material-icons">menu_book</span>성경 읽기</div>
    <div class="menu-item" onclick="showHighlights()"><span class="material-icons">stars</span>관심성구 보기</div>
</div>

<header id="app-header" style="display:none;">
    <button onclick="toggleMenu()" style="background:none; border:none; color:white;"><span class="material-icons">menu</span></button>
    <div class="header-title" id="bible-nav-area">
        <div class="nav-box"><span id="title-txt">창세기</span><span class="material-icons">expand_more</span><select id="book-sel" onchange="changeBook()"></select></div>
        <div class="nav-box"><span id="chap-txt">1장</span><span class="material-icons">expand_more</span><select id="chap-sel" onchange="changeChap()"></select></div>
    </div>
    <div id="hl-title-area" style="display:none; flex:1; text-align:center; font-weight:bold; font-size:18px;">내 관심성구</div>
    <div style="width:40px;"></div>
</header>

<div id="content-wrapper">
    <div id="home-view">
        <h1 style="color:var(--main); font-size: 48px; margin-bottom: 10px;">성경</h1>
        <div id="resume-area" style="display:none;">
            <p style="color:#00796b; font-weight: bold;">이미 성경 데이터가 등록되어 있습니다.</p>
            <button class="btn-main" onclick="goToRead()">성경 읽기 시작</button><br>
            <label style="color:#888; font-size:13px; text-decoration:underline; cursor:pointer;">파일 다시 업로드<input type="file" id="bible-file-re" accept=".txt" style="display:none;"></label>
        </div>
        <div id="status-area">
            <p style="color:#888;">데이터 파일이 없습니다.</p>
            <label class="btn-main">파일 업로드 (txt)<input type="file" id="bible-file" accept=".txt" style="display:none;"></label>
        </div>
    </div>
    <div id="view"></div>
</div>

<div class="fab-container" id="fab-area" style="display:none;">
    <button class="fab" onclick="moveStep(-1)"><span class="material-icons">chevron_left</span></button>
    <button class="fab" onclick="moveStep(1)"><span class="material-icons">chevron_right</span></button>
</div>

<div id="toolbar">
    <div class="tool-btns">
        <button onclick="toggleHighlight()" class="tool-btn"><span class="material-icons" style="color:#d4a017">border_color</span>관심성구</button>
        <button onclick="copyVerses()" class="tool-btn"><span class="material-icons" style="color:var(--accent)">content_copy</span>복사하기</button>
    </div>
</div>

<div id="toast"></div>

<script>
    const bookList = ["창", "출", "레", "민", "신", "수", "삿", "룻", "삼상", "삼하", "왕상", "왕하", "대상", "대하", "스", "느", "에", "욥", "시", "잠", "전", "아", "사", "렘", "애", "겔", "단", "호", "욜", "암", "옵", "요나", "미", "나", "합", "습", "학", "슥", "말", "마", "막", "눅", "요", "행", "롬", "고전", "고후", "갈", "엡", "빌", "골", "살전", "살후", "딤전", "딤후", "딛", "몬", "히", "약", "벧전", "벧후", "요일", "요이", "요삼", "유", "계"];
    const bookFullNames = ["창세기", "출애굽기", "레위기", "민수기", "신명기", "여호수아", "사사기", "룻기", "사무엘상", "사무엘하", "열왕기상", "열왕기하", "역대상", "역대하", "에스라", "느헤미야", "에스더", "욥기", "시편", "잠언", "전도서", "아가", "이사야", "예레미야", "예레미야 애가", "에스겔", "다니엘", "호세아", "요엘", "아모스", "오바댜", "요나", "미가", "나훔", "하박국", "스바냐", "학개", "스가랴", "말라기", "마태복음", "마가복음", "누가복음", "요한복음", "사도행전", "로마서", "고린도전서", "고린도후서", "갈라디아서", "에페소서", "빌립보서", "골로새서", "데살로니가전서", "데살로니가후서", "디모데전서", "디모데후서", "디도서", "빌레몬서", "히브리서", "야고보서", "베드로전서", "베드로후서", "요한일서", "요한이서", "요한삼서", "유다서", "요한계시록"];
    const chaptersPerBook = [50, 40, 27, 36, 34, 24, 21, 4, 31, 24, 22, 25, 29, 36, 10, 13, 10, 42, 150, 31, 12, 8, 66, 52, 5, 48, 12, 14, 3, 9, 1, 4, 7, 3, 3, 3, 2, 14, 4, 28, 16, 24, 21, 28, 16, 16, 13, 6, 6, 4, 4, 5, 3, 6, 4, 3, 1, 13, 5, 5, 3, 5, 1, 1, 1, 22];

    let bibleData = localStorage.getItem('bible_text_v2') || "";
    let highlights = JSON.parse(localStorage.getItem('bible_highlights') || "{}");
    let currentBookIdx = 0, currentChap = 1, selectedVerses = new Set();
    let longPressTimer;

    const bookSel = document.getElementById('book-sel');
    bookFullNames.forEach((name, i) => {
        const opt = document.createElement('option');
        opt.value = i; opt.innerText = name;
        bookSel.appendChild(opt);
    });

    if(bibleData) {
        document.getElementById('status-area').style.display = 'none';
        document.getElementById('resume-area').style.display = 'block';
    }

    const handleFile = e => {
        const reader = new FileReader();
        reader.onload = ev => {
            localStorage.setItem('bible_text_v2', ev.target.result);
            location.reload();
        };
        reader.readAsText(e.target.files[0], "EUC-KR");
    };
    document.getElementById('bible-file').onchange = handleFile;
    document.getElementById('bible-file-re').onchange = handleFile;

    function toggleMenu() {
        document.getElementById('side-menu').classList.toggle('active');
        const overlay = document.getElementById('overlay');
        overlay.style.display = overlay.style.display === 'block' ? 'none' : 'block';
    }

    function goHome() {
        toggleMenu();
        document.getElementById('app-header').style.display = 'none';
        document.getElementById('fab-area').style.display = 'none';
        document.getElementById('home-view').style.display = 'block';
        document.getElementById('view').innerHTML = "";
    }

    function goToRead(targetVerse = null) {
        if(document.getElementById('side-menu').classList.contains('active')) toggleMenu();
        document.getElementById('home-view').style.display = 'none';
        document.getElementById('app-header').style.display = 'flex';
        document.getElementById('bible-nav-area').style.display = 'flex';
        document.getElementById('hl-title-area').style.display = 'none';
        document.getElementById('fab-area').style.display = 'flex';
        renderBible('', targetVerse);
    }

    function renderBible(direction = '', targetVerse = null) {
        const wrapper = document.getElementById('content-wrapper');
        if(direction) {
            wrapper.className = direction === 'next' ? 'slide-left' : 'slide-right';
            setTimeout(() => { doRender(targetVerse); wrapper.className = ''; }, 150);
        } else { doRender(targetVerse); }
    }

    function doRender(targetVerse) {
        selectedVerses.clear();
        document.getElementById('toolbar').style.display = 'none';
        document.getElementById('title-txt').innerText = bookFullNames[currentBookIdx];
        document.getElementById('chap-txt').innerText = currentChap + "장";
        
        const chapSel = document.getElementById('chap-sel');
        chapSel.innerHTML = "";
        for(let i=1; i<=chaptersPerBook[currentBookIdx]; i++) {
            const opt = document.createElement('option');
            opt.value = i; opt.innerText = i + "장";
            chapSel.appendChild(opt);
        }
        chapSel.value = currentChap;
        bookSel.value = currentBookIdx;

        const prefix = bookList[currentBookIdx] + currentChap + ":";
        const lines = bibleData.split('\n');
        let html = `<h2 style="text-align:center; color:#8d6e63; margin-bottom:30px;">${bookFullNames[currentBookIdx]} ${currentChap}장</h2>`;
        
        lines.forEach(line => {
            const tLine = line.trim();
            if(tLine.startsWith(prefix)) {
                const parts = tLine.split(' ');
                const vNum = parseInt(parts[0].split(':')[1]);
                const vText = tLine.replace(parts[0], '').trim();
                const key = `${bookList[currentBookIdx]}_${currentChap}_${vNum}`;
                const hlClass = highlights[key] ? 'hl-text' : '';
                
                html += `<div class="verse" id="v-${vNum}" onclick="selectVerse(this, ${vNum})">
                            <span class="v-num">${vNum}</span>
                            <span class="v-text"><span class="${hlClass}">${vText}</span></span>
                         </div>`;
            }
        });
        document.getElementById('view').innerHTML = html;
        
        if(targetVerse) {
            setTimeout(() => {
                const el = document.getElementById(`v-${targetVerse}`);
                if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
        } else { window.scrollTo(0,0); }
    }

    function changeBook() { currentBookIdx = parseInt(bookSel.value); currentChap = 1; renderBible(); }
    function changeChap() { currentChap = parseInt(document.getElementById('chap-sel').value); renderBible(); }

    function moveStep(step) {
        let nIdx = currentBookIdx, nChap = currentChap + step;
        if(nChap < 1) {
            if(nIdx === 0) { showToast("첫 장입니다."); return; }
            nIdx--; nChap = chaptersPerBook[nIdx];
            currentBookIdx = nIdx; currentChap = nChap; renderBible('prev');
        } else if(nChap > chaptersPerBook[nIdx]) {
            if(nIdx === 65) { showToast("마지막 장입니다."); return; }
            nIdx++; nChap = 1;
            currentBookIdx = nIdx; currentChap = nChap; renderBible('next');
        } else {
            currentChap = nChap; renderBible(step > 0 ? 'next' : 'prev');
        }
    }

    function selectVerse(el, num) {
        if(selectedVerses.has(num)) { selectedVerses.delete(num); el.classList.remove('selected'); }
        else { selectedVerses.add(num); el.classList.add('selected'); }
        document.getElementById('toolbar').style.display = selectedVerses.size > 0 ? 'block' : 'none';
    }

    function toggleHighlight() {
        selectedVerses.forEach(num => {
            const key = `${bookList[currentBookIdx]}_${currentChap}_${num}`;
            if(highlights[key]) delete highlights[key]; else highlights[key] = true;
        });
        localStorage.setItem('bible_highlights', JSON.stringify(highlights));
        doRender();
        showToast("관심성구가 업데이트되었습니다.");
    }

    function showHighlights() {
        toggleMenu();
        document.getElementById('home-view').style.display = 'none';
        document.getElementById('app-header').style.display = 'flex';
        document.getElementById('bible-nav-area').style.display = 'none';
        document.getElementById('hl-title-area').style.display = 'block';
        document.getElementById('fab-area').style.display = 'none';
        
        let html = "";
        let found = false;
        const lines = bibleData.split('\n');
        
        const sortedKeys = Object.keys(highlights).sort((a,b) => {
            const [b1, c1, v1] = a.split('_');
            const [b2, c2, v2] = b.split('_');
            if(bookList.indexOf(b1) !== bookList.indexOf(b2)) return bookList.indexOf(b1) - bookList.indexOf(b2);
            if(parseInt(c1) !== parseInt(c2)) return parseInt(c1) - parseInt(c2);
            return parseInt(v1) - parseInt(v2);
        });

        sortedKeys.forEach(key => {
            const [b, c, v] = key.split('_');
            const prefix = b + c + ":" + v + " ";
            const line = lines.find(l => l.trim().startsWith(prefix));
            if(line) {
                found = true;
                const vText = line.split(' ').slice(1).join(' ');
                const bIdx = bookList.indexOf(b);
                const bFull = bookFullNames[bIdx];
                
                // 롱프레스 핸들러 추가
                html += `<div class="hl-item" 
                            onmousedown="startPress('${key}')" onmouseup="endPress('${key}', ${bIdx}, ${c}, ${v})"
                            ontouchstart="startPress('${key}')" ontouchend="endPress('${key}', ${bIdx}, ${c}, ${v})">
                            <small style="color:#8d6e63; font-weight:bold;">${bFull} ${c}:${v}</small><br>
                            <span class="v-text">${vText}</span>
                         </div>`;
            }
        });
        document.getElementById('view').innerHTML = found ? html : "<p style='text-align:center; padding-top:50px; color:#999;'>저장된 관심성구가 없습니다.</p>";
        window.scrollTo(0,0);
    }

    // 롱프레스 및 탭 로직
    function startPress(key) {
        longPressTimer = setTimeout(() => {
            longPressTimer = null;
            if(confirm("이 성구를 관심성구에서 삭제하시겠습니까?")) {
                delete highlights[key];
                localStorage.setItem('bible_highlights', JSON.stringify(highlights));
                showHighlights();
                showToast("삭제되었습니다.");
            }
        }, 800); // 0.8초 꾹 누르면 삭제 팝업
    }

    function endPress(key, bIdx, c, v) {
        if(longPressTimer) {
            clearTimeout(longPressTimer);
            jumpToVerse(bIdx, c, v);
        }
    }

    function jumpToVerse(bIdx, c, v) {
        currentBookIdx = bIdx;
        currentChap = parseInt(c);
        goToRead(v);
    }

    function copyVerses() {
        const nums = Array.from(selectedVerses).sort((a,b) => a-b);
        let range = [];
        let start = nums[0], prev = nums[0];
        for(let i=1; i<=nums.length; i++){
            if(i < nums.length && nums[i] === prev + 1) prev = nums[i];
            else { range.push(start === prev ? start : `${start}-${prev}`); if(i < nums.length) start = prev = nums[i]; }
        }
        let txt = "";
        nums.forEach(n => {
            const el = document.querySelector(`.verse[id="v-${n}"] .v-text`);
            txt += el.innerText + "\n";
        });
        const final = `${bookFullNames[currentBookIdx]} ${currentChap}장 ${range.join(', ')}절\n${txt.trim()}`;
        const t = document.createElement("textarea");
        t.value = final; document.body.appendChild(t); t.select();
        document.execCommand('copy'); document.body.removeChild(t);
        showToast("복사되었습니다.");
        doRender();
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 2000);
    }
</script>

</body>
</html>